<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SEHC Hometown 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        .glass-header { background: #2563eb; color: white; position: sticky; top: 0; z-index: 50; }
        .card-family { background: white; border-radius: 1rem; border: 1px solid #e2e8f0; transition: all 0.3s ease; }
        .family-all-on { border-left: 6px solid #22c55e !important; background-color: #f0fdf4 !important; }
        .hidden { display: none !important; }
        /* T·ªëi ∆∞u c·∫£m ·ª©ng mobile */
        button:active { transform: scale(0.96); }
        .btn-call { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #dcfce7; color: #166534; }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen flex flex-col relative">

    <div id="loader" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-slate-500 animate-pulse font-medium">ƒêang kh·ªüi t·∫°o h·ªá th·ªëng...</p>
    </div>

    <div id="view-login" class="hidden p-6 animate__animated animate__fadeIn">
        <div class="text-center my-12">
            <div class="text-6xl mb-4">üöå</div>
            <h1 class="text-3xl font-extrabold text-blue-900 tracking-tight">Hometown 2026</h1>
            <p class="text-slate-500 font-medium mt-1">H·ªá th·ªëng ƒëi·ªÉm danh Tr∆∞·ªüng xe</p>
        </div>
        <div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-100 space-y-4">
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase ml-1">Ch·ªçn s·ªë xe</label>
                <select id="login-bus" class="w-full mt-1 p-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 ring-blue-500 text-sm font-semibold"></select>
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase ml-1">M·∫≠t kh·∫©u (SƒêT)</label>
                <input id="login-phone" type="password" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i tr∆∞·ªüng xe" class="w-full mt-1 p-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 ring-blue-500">
            </div>
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-200">B·∫ÆT ƒê·∫¶U ƒêI·ªÇM DANH</button>
            <button onclick="checkAdmin()" class="w-full text-slate-400 text-xs py-2">Qu·∫£n tr·ªã vi√™n Ban T·ªï Ch·ª©c</button>
        </div>
    </div>

    <div id="view-attendance" class="hidden flex-1 flex flex-col">
        <div class="glass-header p-4 shadow-lg">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 id="display-bus-id" class="text-2xl font-bold">Xe 01</h2>
                    <div id="progress-bar-container" class="mt-2 flex items-center gap-2">
                        <div class="w-32 bg-blue-900/30 h-2 rounded-full overflow-hidden">
                            <div id="progress-fill" class="bg-green-400 h-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <span id="progress-text" class="text-[10px] font-bold uppercase tracking-wider">0/0 kh√°ch</span>
                    </div>
                </div>
                <button onclick="logout()" class="p-2 bg-white/10 rounded-xl"><i class="fa fa-right-from-bracket"></i></button>
            </div>
            <div class="relative">
                <input type="text" id="search-input" onkeyup="renderList()" placeholder="T√¨m t√™n, GenID..." class="w-full p-3 pl-10 rounded-xl text-slate-900 text-sm outline-none shadow-inner border-none">
                <i class="fa fa-search absolute left-3 top-3.5 text-slate-400 text-sm"></i>
            </div>
        </div>

        <div id="passenger-list" class="p-4 space-y-4 pb-32"></div>

        <div class="fixed bottom-0 left-0 right-0 p-4 max-w-md mx-auto bg-white/80 backdrop-blur-md border-t border-slate-100 flex gap-2">
            <button onclick="updateBus('Departed')" class="flex-1 bg-green-600 text-white py-4 rounded-2xl font-bold text-sm shadow-lg active:bg-green-700">X√ÅC NH·∫¨N KH·ªûI H√ÄNH</button>
            <button onclick="updateBus('Arrived')" class="flex-1 bg-blue-900 text-white py-4 rounded-2xl font-bold text-sm shadow-lg active:bg-black">X√ÅC NH·∫¨N ƒê·∫æN N∆†I</button>
        </div>
    </div>

    <div id="view-admin" class="hidden p-4 pb-10">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-extrabold text-blue-900">Ban T·ªï Ch·ª©c</h2>
            <button onclick="showView('view-login')" class="text-slate-400 text-xl"><i class="fa fa-times"></i></button>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-6" id="admin-stats-grid">
            </div>

        <div id="admin-bus-list" class="space-y-3"></div>
    </div>

</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzk8x_2IEhLDMuGZ83E0A9UubDTtAVz6Oj5xEbT2Qk_0CCX2NDgFHGG4E_fcfzADrNBqw/exec";
    let rawData = null;
    let currentBusId = null;
    let expandedFamilies = new Set();

    // 1. LIFECYCLE: Kh·ªüi ƒë·ªông app
    window.onload = () => {
        const cached = localStorage.getItem('sehc_hometown_2026_cache');
        if (cached) {
            rawData = JSON.parse(cached);
            initLoginOptions();
            showView('view-login');
            hideLoader();
        }
        // Lu√¥n fetch d·ªØ li·ªáu m·ªõi nh·∫•t ng·∫ßm
        fetchData();
    };

    async function fetchData() {
        try {
            const resp = await fetch(API_URL);
            const data = await resp.json();
            if (data.error) throw new Error(data.error);
            
            rawData = data;
            localStorage.setItem('sehc_hometown_2026_cache', JSON.stringify(data));
            
            initLoginOptions();
            hideLoader();
            
            // N·∫øu ƒëang ·ªü m√†n h√¨nh n√†o ƒë√≥ th√¨ refresh UI ngay l·∫≠p t·ª©c
            if (currentBusId) renderList();
            if (document.getElementById('view-admin').classList.contains('hidden') === false) renderAdmin();
            
            console.log("Background Data Synced ‚úÖ");
        } catch (e) {
            console.error("Sync Error:", e);
            if (!rawData) {
                Swal.fire("L·ªói k·∫øt n·ªëi", "Vui l√≤ng ki·ªÉm tra Internet", "error");
                hideLoader();
            }
        }
    }

    function initLoginOptions() {
        const select = document.getElementById('login-bus');
        if (!select || !rawData.captains) return;
        select.innerHTML = '<option value="">Ch·ªçn xe...</option>';
        rawData.captains.sort((a,b) => a.BusID - b.BusID).forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.BusID;
            opt.innerText = `Xe ${c.BusID} - ${c.Province} (${c.Name})`;
            select.appendChild(opt);
        });
    }

    // 2. LOGIC ƒêƒÇNG NH·∫¨P
    function handleLogin() {
        const bid = document.getElementById('login-bus').value;
        const phone = document.getElementById('login-phone').value;
        if (!bid || !phone) return Swal.fire("Thi·∫øu th√¥ng tin", "Vui l√≤ng ch·ªçn xe v√† nh·∫≠p m·∫≠t kh·∫©u", "warning");

        const cap = rawData.captains.find(c => c.BusID == bid && String(c.Phone).includes(phone));
        if (cap) {
            currentBusId = bid;
            document.getElementById('display-bus-id').innerText = `Xe ${bid}`;
            showView('view-attendance');
            renderList();
        } else {
            Swal.fire("Sai m·∫≠t kh·∫©u", "S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë√∫ng v·ªõi Tr∆∞·ªüng xe n√†y", "error");
        }
    }

    // 3. LOGIC ƒêI·ªÇM DANH (ATTENDANCE)
    function renderList() {
        const container = document.getElementById('passenger-list');
        const keyword = document.getElementById('search-input').value.toLowerCase();
        container.innerHTML = "";

        const passengers = rawData.passengers.filter(p => p.BusID == currentBusId);
        
        // Th·ªëng k√™ progress
        const total = passengers.length;
        const onBoard = passengers.filter(p => p.StatusOn).length;
        const percent = total > 0 ? (onBoard / total) * 100 : 0;
        document.getElementById('progress-fill').style.width = percent + "%";
        document.getElementById('progress-text').innerText = `${onBoard}/${total} kh√°ch`;

        // Nh√≥m theo gia ƒë√¨nh (GenID)
        const families = {};
        passengers.forEach(p => {
            if (!families[p.GenID]) families[p.GenID] = [];
            families[p.GenID].push(p);
        });

        // S·∫Øp x·∫øp: Ai ch∆∞a ƒëi·ªÉm danh xong l√™n ƒë·∫ßu
        const sortedIds = Object.keys(families).sort((a, b) => {
            const aDone = families[a].every(m => m.StatusOn || m.Reason);
            const bDone = families[b].every(m => m.StatusOn || m.Reason);
            return aDone - bDone;
        });

        sortedIds.forEach(gid => {
            const members = families[gid];
            const main = members.find(m => m.Note === "Ng∆∞·ªùi ƒëƒÉng k√Ω") || members[0];
            const isAllOn = members.every(m => m.StatusOn || m.Reason);
            
            // Search filter
            if (keyword && !members.some(m => m.Name.toLowerCase().includes(keyword) || String(m.GenID).includes(keyword))) return;

            const isOpen = expandedFamilies.has(gid) || keyword !== "";
            const card = document.createElement('div');
            card.className = `card-family shadow-sm overflow-hidden ${isAllOn ? 'family-all-on' : ''}`;
            
            let htmlRows = members.map(m => `
                <div class="p-4 border-t border-slate-50 ${m.StatusOn ? 'bg-green-50/30' : ''}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <p class="font-bold text-sm text-slate-800">${m.Name}</p>
                            <p class="text-[10px] text-slate-500 font-medium tracking-tight uppercase">${m.Dept} ‚Ä¢ ${m.Note}</p>
                            <p class="text-[10px] text-blue-600 mt-1 font-bold"><i class="fa fa-location-dot mr-1"></i>${m.Route || 'Ch∆∞a r√µ l·ªô tr√¨nh'}</p>
                        </div>
                        <a href="tel:${m.Phone}" class="btn-call shadow-sm"><i class="fa fa-phone"></i></a>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="toggleAttendance('${gid}','${m.Name}','on')" class="flex-1 py-2 rounded-xl text-[10px] font-extrabold border-2 transition-all ${m.StatusOn ? 'bg-green-600 border-green-600 text-white' : 'border-slate-200 text-slate-400'}">L√äN XE</button>
                        <button onclick="toggleAttendance('${gid}','${m.Name}','off')" class="flex-1 py-2 rounded-xl text-[10px] font-extrabold border-2 transition-all ${m.StatusOff ? 'bg-blue-600 border-blue-600 text-white' : 'border-slate-200 text-slate-400'}">XU·ªêNG</button>
                        <button onclick="cancelAttendance('${gid}','${m.Name}')" ${m.StatusOn ? 'disabled' : ''} class="px-3 rounded-xl border-2 ${m.Reason ? 'bg-red-500 border-red-500 text-white' : 'border-slate-100 text-slate-200'} ${m.StatusOn ? 'opacity-20' : ''}">
                            <i class="fa fa-user-slash"></i>
                        </button>
                    </div>
                    ${m.Reason ? `<p class="mt-2 text-[9px] text-red-500 font-bold bg-red-50 p-1 px-2 rounded italic">L√Ω do: ${m.Reason}</p>` : ''}
                </div>
            `).join('');

            card.innerHTML = `
                <div class="p-4 flex justify-between items-center" onclick="toggleExpand('${gid}')">
                    <div>
                        <p class="font-bold text-blue-900">${main.Name}</p>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">M√£ NV: ${gid}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full font-bold">${members.length} ng∆∞·ªùi</span>
                        <i class="fa ${isOpen ? 'fa-chevron-up' : 'fa-chevron-down'} text-slate-300"></i>
                    </div>
                </div>
                <div class="${isOpen ? '' : 'hidden'}">${htmlRows}</div>
            `;
            container.appendChild(card);
        });
    }

    function toggleAttendance(gid, name, type) {
        const p = rawData.passengers.find(x => x.GenID == gid && x.Name == name);
        const key = type === 'on' ? 'StatusOn' : 'StatusOff';
        p[key] = !p[key];
        renderList(); // Optimistic UI
        // G·ª≠i ng·∫ßm
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "updateAttendance", genId: gid, name, type, value: p[key] }) });
    }

    async function cancelAttendance(gid, name) {
        const { value: reason } = await Swal.fire({ 
            title: 'H·ªßy tham gia?', 
            input: 'text', 
            inputPlaceholder: 'Nh·∫≠p l√Ω do v·∫Øng m·∫∑t...', 
            showCancelButton: true,
            confirmButtonColor: '#ef4444'
        });
        if (reason) {
            const p = rawData.passengers.find(x => x.GenID == gid && x.Name == name);
            p.Reason = reason; p.StatusOn = false; p.StatusOff = false;
            renderList();
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "updateAttendance", genId: gid, name, type: "cancel", reason }) });
        }
    }

    function updateBus(status) {
        Swal.fire({ title: 'X√°c nh·∫≠n?', text: `C·∫≠p nh·∫≠t tr·∫°ng th√°i xe: ${status}`, icon: 'question', showCancelButton: true })
        .then(r => {
            if(r.isConfirmed) {
                const b = rawData.buses.find(x => x.BusID == currentBusId);
                if(b) b.Status = status;
                Swal.fire("Th√†nh c√¥ng", "", "success");
                fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "updateBusStatus", busId: currentBusId, status }) });
            }
        });
    }

    // 4. LOGIC ADMIN
    async function checkAdmin() {
        const { value: pin } = await Swal.fire({ title: 'BTC PIN', input: 'password', inputAttributes: { maxlength: 4 } });
        if (pin === "2026") {
            showView('view-admin');
            renderAdmin();
        } else if(pin) {
            Swal.fire("Sai PIN", "", "error");
        }
    }

    function renderAdmin() {
        const buses = rawData.buses;
        const pass = rawData.passengers;
        const capts = rawData.captains;

        let full = 0, pending = 0, departed = 0, arrived = 0;
        const list = document.getElementById('admin-bus-list');
        list.innerHTML = "";

        buses.sort((a,b)=>a.BusID - b.BusID).forEach(b => {
            const c = capts.find(x => x.BusID == b.BusID) || {};
            const pOnBus = pass.filter(p => p.BusID == b.BusID);
            const onCount = pOnBus.filter(p => p.StatusOn).length;
            const isFull = (onCount === pOnBus.length && pOnBus.length > 0);
            
            if (isFull) full++; else pending++;
            if (b.Status === 'Departed') departed++;
            if (b.Status === 'Arrived') arrived++;

            const div = document.createElement('div');
            div.className = "bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-100";
            div.innerHTML = `
                <div>
                    <p class="font-bold text-blue-900">Xe ${b.BusID} - ${c.Province || '---'}</p>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tight">TX: ${c.Name}</p>
                    <div class="flex items-center gap-2 mt-2">
                        <span class="text-[10px] font-bold ${isFull ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'} px-2 py-0.5 rounded-full">${onCount}/${pOnBus.length} kh√°ch</span>
                        <span class="text-[10px] bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full font-bold uppercase">${b.Status || 'Waiting'}</span>
                    </div>
                </div>
                <a href="tel:${c.Phone}" class="btn-call shadow-md"><i class="fa fa-phone"></i></a>
            `;
            list.appendChild(div);
        });

        document.getElementById('admin-stats-grid').innerHTML = `
            <div class="bg-white p-4 rounded-2xl border-b-4 border-green-500 shadow-sm">
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Xe ƒë·ªß kh√°ch</p>
                <p class="text-2xl font-black text-green-600">${full}</p>
            </div>
            <div class="bg-white p-4 rounded-2xl border-b-4 border-orange-500 shadow-sm">
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Xe c√≤n thi·∫øu</p>
                <p class="text-2xl font-black text-orange-500">${pending}</p>
            </div>
            <div class="bg-blue-600 p-4 rounded-2xl shadow-sm text-white">
                <p class="text-[9px] opacity-70 font-bold uppercase tracking-widest">ƒê√£ kh·ªüi h√†nh</p>
                <p class="text-2xl font-black">${departed}</p>
            </div>
            <div class="bg-slate-900 p-4 rounded-2xl shadow-sm text-white">
                <p class="text-[9px] opacity-70 font-bold uppercase tracking-widest">ƒê√£ ƒë·∫øn n∆°i</p>
                <p class="text-2xl font-black text-blue-400">${arrived}</p>
            </div>
        `;
    }

    // 5. UTILS
    function showView(id) {
        ['view-login', 'view-attendance', 'view-admin'].forEach(v => document.getElementById(v).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        window.scrollTo(0,0);
    }
    function toggleExpand(id) {
        if (expandedFamilies.has(id)) expandedFamilies.delete(id); else expandedFamilies.add(id);
        renderList();
    }
    function hideLoader() { document.getElementById('loader').classList.add('hidden'); }
    function logout() { 
        Swal.fire({ title: 'ƒêƒÉng xu·∫•t?', text: "D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c x√≥a kh·ªèi b·ªô nh·ªõ m√°y", showCancelButton: true })
        .then(r => { if(r.isConfirmed) { localStorage.removeItem('sehc_hometown_2026_cache'); location.reload(); } });
    }
</script>
</body>
</html>
