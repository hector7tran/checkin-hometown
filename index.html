<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hometown 2026 - SEHC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .glass-card { background: white; border: 1px solid #e2e8f0; border-radius: 1rem; overflow: hidden; }
        .family-done { background-color: #dcfce7 !important; border-left: 5px solid #22c55e !important; }
        .sticky-header { position: sticky; top: 0; z-index: 100; background: #2563eb; color: white; padding: 1rem; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col">
        
        <div id="loader" class="flex-1 flex flex-col items-center justify-center p-10">
            <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-slate-500 font-medium">ƒêang ki·ªÉm tra d·ªØ li·ªáu...</p>
        </div>

        <div id="view-login" class="hidden p-6">
            <div class="text-center my-10">
                <div class="text-6xl mb-4">üöå</div>
                <h1 class="text-2xl font-bold text-blue-900">Hometown 2026</h1>
                <p class="text-slate-500">SEHC Employee Relations</p>
            </div>
            <div class="glass-card p-6 space-y-4 shadow-xl">
                <select id="login-bus" class="w-full p-4 border rounded-xl bg-white outline-none focus:ring-2 ring-blue-500 text-sm"></select>
                <input id="login-phone" type="password" placeholder="SƒêT Tr∆∞·ªüng xe (M·∫≠t kh·∫©u)" class="w-full p-4 border rounded-xl outline-none focus:ring-2 ring-blue-500">
                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all">ƒêƒÇNG NH·∫¨P</button>
                <button onclick="showAdminLogin()" class="w-full text-slate-400 text-xs pt-2">Ban T·ªï Ch·ª©c (Qu·∫£n tr·ªã)</button>
            </div>
        </div>

        <div id="view-attendance" class="hidden flex-1 flex flex-col">
            <div class="sticky-header shadow-lg">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h2 id="display-bus-id" class="text-xl font-bold">Xe 01</h2>
                        <div id="bus-progress-text" class="text-[11px] bg-white/20 inline-block px-2 py-0.5 rounded-full mt-1 font-semibold">ƒê√£ l√™n: 0/0</div>
                    </div>
                    <button onclick="logout()"><i class="fa fa-sign-out-alt text-xl"></i></button>
                </div>
                <div class="relative">
                    <input type="text" id="search-input" onkeyup="renderPassengerList()" placeholder="T√¨m t√™n ho·∫∑c M√£ nh√¢n vi√™n..." class="w-full p-3 pl-10 rounded-xl text-slate-900 outline-none text-sm shadow-inner">
                    <i class="fa fa-search absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                </div>
            </div>
            <div id="passenger-list" class="p-3 space-y-4 pb-32"></div>
            <div class="fixed bottom-0 left-0 right-0 p-4 max-w-md mx-auto bg-white/90 backdrop-blur-md border-t flex gap-2">
                <button onclick="confirmBusStatus('Departed')" class="flex-1 bg-green-600 text-white py-3.5 rounded-xl font-bold text-sm shadow-md">XE KH·ªûI H√ÄNH</button>
                <button onclick="confirmBusStatus('Arrived')" class="flex-1 bg-blue-900 text-white py-3.5 rounded-xl font-bold text-sm shadow-md">XE ƒê·∫æN N∆†I</button>
            </div>
        </div>

        <div id="view-admin" class="hidden p-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-900 text-center flex-1">B√°o c√°o BTC</h2>
                <button onclick="logout()"><i class="fa fa-times text-xl text-slate-400"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-6" id="admin-summary">
                </div>
            <div id="admin-bus-list" class="space-y-3 pb-10"></div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzk8x_2IEhLDMuGZ83E0A9UubDTtAVz6Oj5xEbT2Qk_0CCX2NDgFHGG4E_fcfzADrNBqw/exec";
        let rawData = null;
        let currentBus = null;
        let expandedFamilies = new Set();

        window.onload = async () => {
            // B∆∞·ªõc 1: Ki·ªÉm tra cache
            const cached = localStorage.getItem('hometown_cache_2026');
            if (cached) {
                try {
                    rawData = JSON.parse(cached);
                    if (rawData && rawData.captains) {
                        initLogin();
                        showView('view-login');
                    }
                } catch(e) { localStorage.removeItem('hometown_cache_2026'); }
            }
            // B∆∞·ªõc 2: T·∫£i d·ªØ li·ªáu m·ªõi
            fetchData();
        };

        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                rawData = data;
                localStorage.setItem('hometown_cache_2026', JSON.stringify(data));
                
                initLogin();
                hideLoader();
                
                // N·∫øu ƒëang ·ªü m√†n h√¨nh n√†o ƒë√≥ th√¨ re-render
                if (currentBus) renderPassengerList();
                else showView('view-login');

            } catch (err) {
                hideLoader();
                console.error(err);
                if (!rawData) {
                    Swal.fire({
                        title: "L·ªói k·∫øt n·ªëi",
                        text: "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra Internet ho·∫∑c quy·ªÅn truy c·∫≠p c·ªßa Link GAS.",
                        icon: "error"
                    });
                }
            }
        }

        function initLogin() {
            const select = document.getElementById('login-bus');
            if (!select || !rawData || !rawData.captains) return;
            
            select.innerHTML = '<option value="">-- Ch·ªçn xe c·ªßa b·∫°n --</option>';
            rawData.captains.sort((a,b) => a.BusID - b.BusID).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.BusID;
                opt.innerText = `Xe ${c.BusID} - ${c.Province} (${c.Name})`;
                select.appendChild(opt);
            });
        }

        function showView(viewId) {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-attendance').classList.add('hidden');
            document.getElementById('view-admin').classList.add('hidden');
            
            const target = document.getElementById(viewId);
            if (target) target.classList.remove('hidden');
        }

        function handleLogin() {
            const bid = document.getElementById('login-bus').value;
            const phone = document.getElementById('login-phone').value;
            if (!bid || !phone) return Swal.fire("Ch√∫ √Ω", "Vui l√≤ng ch·ªçn xe v√† nh·∫≠p SƒêT", "warning");

            const cap = rawData.captains.find(c => c.BusID == bid && String(c.Phone).includes(phone));
            if (cap) {
                currentBus = bid;
                document.getElementById('display-bus-id').innerText = `Xe ${bid}`;
                showView('view-attendance');
                renderPassengerList();
            } else {
                Swal.fire("L·ªói", "S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë√∫ng v·ªõi tr∆∞·ªüng xe n√†y!", "error");
            }
        }

        function renderPassengerList() {
            const container = document.getElementById('passenger-list');
            const keyword = document.getElementById('search-input').value.toLowerCase();
            if (!container) return;
            container.innerHTML = "";
            
            const list = rawData.passengers.filter(p => p.BusID == currentBus);
            const totalOn = list.filter(p => p.StatusOn).length;
            document.getElementById('bus-progress-text').innerText = `ƒê√£ l√™n: ${totalOn}/${list.length}`;

            const families = {};
            list.forEach(p => {
                if (!families[p.GenID]) families[p.GenID] = [];
                families[p.GenID].push(p);
            });

            // S·∫Øp x·∫øp: Nh√† ch∆∞a xong l√™n ƒë·∫ßu
            const sortedGenIds = Object.keys(families).sort((a, b) => {
                const aDone = families[a].every(m => m.StatusOn || m.Reason);
                const bDone = families[b].every(m => m.StatusOn || m.Reason);
                return aDone - bDone;
            });

            sortedGenIds.forEach(genId => {
                const members = families[genId];
                const main = members.find(m => m.Note === "Ng∆∞·ªùi ƒëƒÉng k√Ω") || members[0];
                const isFamilyDone = members.every(m => m.StatusOn || m.Reason);
                
                if (keyword && !members.some(m => m.Name.toLowerCase().includes(keyword) || String(m.GenID).includes(keyword))) return;

                const isOpen = expandedFamilies.has(genId) || keyword !== "";
                const card = document.createElement('div');
                card.className = `glass-card shadow-sm ${isFamilyDone ? 'family-done' : ''}`;
                
                let rows = members.map(m => `
                    <div class="p-4 border-t border-slate-100 ${m.StatusOn ? 'bg-green-50/50' : ''}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="font-bold text-sm">${m.Name} <span class="font-normal text-[10px] text-slate-500">(${m.Note})</span></p>
                                <p class="text-[10px] text-slate-400">Dept: ${m.Dept} | Tuy·∫øn: ${m.Route || '---'}</p>
                            </div>
                            <a href="tel:${m.Phone}" class="w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-xs"><i class="fa fa-phone"></i></a>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="updateAt('${m.GenID}','${m.Name}','on')" class="flex-1 py-2 rounded-lg text-[10px] font-bold border-2 ${m.StatusOn ? 'bg-green-600 border-green-600 text-white' : 'border-slate-200 text-slate-500'}">L√äN XE</button>
                            <button onclick="updateAt('${m.GenID}','${m.Name}','off')" class="flex-1 py-2 rounded-lg text-[10px] font-bold border-2 ${m.StatusOff ? 'bg-blue-600 border-blue-600 text-white' : 'border-slate-200 text-slate-500'}">XU·ªêNG</button>
                            <button onclick="handleCancel('${m.GenID}','${m.Name}')" ${m.StatusOn ? 'disabled' : ''} class="px-3 rounded-lg border-2 ${m.Reason ? 'bg-red-500 border-red-500 text-white' : 'border-slate-100 text-slate-300'} ${m.StatusOn ? 'opacity-20' : ''}">
                                <i class="fa fa-user-xmark"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="p-4 flex justify-between items-center" onclick="toggleF('${genId}')">
                        <div>
                            <p class="font-bold text-blue-900">${main.Name}</p>
                            <p class="text-[10px] text-slate-400">Gen: ${genId}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100">${members.length} ng∆∞·ªùi</span>
                            <i class="fa ${isOpen ? 'fa-chevron-up' : 'fa-chevron-down'} text-slate-300"></i>
                        </div>
                    </div>
                    <div class="${isOpen ? '' : 'hidden'}">${rows}</div>
                `;
                container.appendChild(card);
            });
        }

        function updateAt(gid, name, type) {
            const p = rawData.passengers.find(x => x.GenID == gid && x.Name == name);
            const key = type === 'on' ? 'StatusOn' : 'StatusOff';
            p[key] = !p[key];
            renderPassengerList();
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "updateAttendance", genId: gid, name, type, value: p[key] }) });
        }

        async function handleCancel(gid, name) {
            const { value: reason } = await Swal.fire({ title: 'L√Ω do v·∫Øng m·∫∑t', input: 'text', showCancelButton: true });
            if (reason) {
                const p = rawData.passengers.find(x => x.GenID == gid && x.Name == name);
                p.Reason = reason; p.StatusOn = false; p.StatusOff = false;
                renderPassengerList();
                fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "updateAttendance", genId: gid, name, type: "cancel", reason }) });
            }
        }

        function confirmBusStatus(status) {
            Swal.fire({ title: 'X√°c nh·∫≠n?', text: status, icon: 'question', showCancelButton: true }).then(r => {
                if(r.isConfirmed) fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "updateBusStatus", busId: currentBus, status }) });
            });
        }

        async function showAdminLogin() {
            const { value: pin } = await Swal.fire({ title: 'M√£ PIN', input: 'password' });
            if (pin === "2026") { showView('view-admin'); renderAdmin(); }
        }

        function renderAdmin() {
            const buses = rawData.buses;
            const pass = rawData.passengers;
            let full = 0, pending = 0;
            const list = document.getElementById('admin-bus-list');
            list.innerHTML = "";

            buses.sort((a,b)=>a.BusID-b.BusID).forEach(b => {
                const capt = rawData.captains.find(c => c.BusID == b.BusID) || {};
                const pOnBus = pass.filter(p => p.BusID == b.BusID);
                const on = pOnBus.filter(p => p.StatusOn).length;
                const isFull = (on === pOnBus.length && on > 0);
                if (isFull) full++; else pending++;

                const div = document.createElement('div');
                div.className = "glass-card p-4 flex justify-between items-center shadow-sm";
                div.innerHTML = `
                    <div class="flex-1">
                        <p class="font-bold text-blue-900">Xe ${b.BusID} - ${capt.Province || '---'}</p>
                        <p class="text-[10px] text-slate-500">Tr∆∞·ªüng xe: ${capt.Name} | <span class="${isFull?'text-green-600 font-bold':'text-orange-500'}">L√™n xe: ${on}/${pOnBus.length}</span></p>
                    </div>
                    <a href="tel:${capt.Phone}" class="w-10 h-10 bg-green-100 text-green-600 rounded-full flex items-center justify-center"><i class="fa fa-phone"></i></a>
                `;
                list.appendChild(div);
            });

            document.getElementById('admin-summary').innerHTML = `
                <div class="glass-card p-4 text-center border-b-4 border-green-500"><p class="text-[10px] text-slate-500 font-bold uppercase">Xe ƒë·ªß kh√°ch</p><p class="text-2xl font-bold text-green-600">${full}</p></div>
                <div class="glass-card p-4 text-center border-b-4 border-orange-500"><p class="text-[10px] text-slate-500 font-bold uppercase">Xe ch∆∞a ƒë·ªß</p><p class="text-2xl font-bold text-orange-600">${pending}</p></div>
            `;
        }

        function toggleF(id) { if (expandedFamilies.has(id)) expandedFamilies.delete(id); else expandedFamilies.add(id); renderPassengerList(); }
        function hideLoader() { document.getElementById('loader').classList.add('hidden'); }
        function logout() { localStorage.removeItem('hometown_cache_2026'); location.reload(); }
    </script>
</body>
</html>
