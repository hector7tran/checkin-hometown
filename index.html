<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hometown 2026 - SEHC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        .sticky-header { position: sticky; top: 0; z-index: 50; background: #2563eb; color: white; padding: 1rem; }
        .card-family { background: white; border-radius: 1rem; border: 1px solid #e2e8f0; transition: all 0.2s ease; }
        .family-all-on { border-left: 5px solid #22c55e !important; background-color: #f0fdf4 !important; }
        .family-all-off { border-left: 5px solid #2563eb !important; background-color: #eff6ff !important; }
        .hidden { display: none !important; }
        .btn-call { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #dcfce7; color: #166534; }
        .btn-disabled { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
        .sync-badge { font-size: 10px; background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 10px; }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen flex flex-col relative">

    <div id="loader" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-slate-500 font-medium">ƒêang kh·ªüi t·∫°o d·ªØ li·ªáu...</p>
    </div>

    <div id="view-login" class="hidden p-6 animate__animated animate__fadeIn">
        <div class="text-center my-10">
            <div class="text-6xl mb-4">üöå</div>
            <h1 class="text-3xl font-extrabold text-blue-900 tracking-tight">Hometown 2026</h1>
            <p class="text-slate-500 font-medium">Trang ƒëi·ªÉm danh Tr∆∞·ªüng xe</p>
        </div>
        <div class="bg-white rounded-3xl p-6 shadow-xl space-y-4 border border-slate-100">
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">S·ªë xe v·∫≠n h√†nh</label>
                <select id="login-bus" class="w-full mt-1 p-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 ring-blue-500 text-sm font-semibold"></select>
            </div>
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">M·∫≠t kh·∫©u (SƒêT)</label>
                <input id="login-phone" type="password" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" class="w-full mt-1 p-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 ring-blue-500">
            </div>
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform">V√ÄO ƒêI·ªÇM DANH</button>
            <button onclick="checkAdmin()" class="w-full text-slate-400 text-xs py-2">Qu·∫£n tr·ªã Ban T·ªï Ch·ª©c</button>
        </div>
    </div>

    <div id="view-attendance" class="hidden flex-1 flex flex-col">
        <div class="sticky-header shadow-lg">
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h2 id="display-bus-id" class="text-xl font-bold">Xe 01</h2>
                    <div class="flex items-center gap-2 mt-1">
                        <div class="w-32 bg-blue-900/30 h-1.5 rounded-full overflow-hidden">
                            <div id="progress-fill" class="bg-green-400 h-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div id="stats-header" class="text-[10px] font-bold flex gap-2">
                             <span id="stat-total">3/38 KH√ÅCH</span>
                        </div>
                    </div>
                    <div id="stats-detail" class="text-[9px] mt-1 opacity-80 flex gap-2">
                        <span id="stat-on" class="bg-green-500/20 px-1.5 rounded">L√™n: 0</span>
                        <span id="stat-off" class="bg-blue-500/20 px-1.5 rounded">Xu·ªëng: 0</span>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <button onclick="goBack()" class="p-2 bg-white/20 rounded-xl active:bg-white/40"><i class="fa fa-arrow-left"></i></button>
                    <div class="sync-badge" id="sync-label"><i class="fa fa-sync fa-spin"></i> Live</div>
                </div>
            </div>
            <div class="relative mt-2">
                <input type="text" id="search-input" onkeyup="renderList()" placeholder="T√¨m t√™n, GenID..." class="w-full p-3 pl-10 rounded-xl text-slate-900 text-sm outline-none border-none shadow-inner">
                <i class="fa fa-search absolute left-3 top-3.5 text-slate-400 text-sm"></i>
            </div>
        </div>

        <div id="passenger-list" class="p-3 space-y-3 pb-32"></div>

        <div class="fixed bottom-0 left-0 right-0 p-4 max-w-md mx-auto bg-white/80 backdrop-blur-md border-t border-slate-100 flex gap-2">
            <button id="btn-depart" onclick="updateBus('Departed')" class="flex-1 bg-green-600 text-white py-4 rounded-2xl font-bold text-sm shadow-md">XE KH·ªûI H√ÄNH</button>
            <button id="btn-arrive" onclick="updateBus('Arrived')" class="flex-1 bg-blue-900 text-white py-4 rounded-2xl font-bold text-sm shadow-md">XE ƒê·∫æN N∆†I</button>
        </div>
    </div>

    <div id="view-admin" class="hidden p-4">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-extrabold text-blue-900">Ban T·ªï Ch·ª©c</h2>
            <button onclick="goBack()" class="text-slate-400 text-xl"><i class="fa fa-times"></i></button>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-6" id="admin-stats-grid"></div>
        <div id="admin-bus-list" class="space-y-3 pb-10"></div>
    </div>

</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzk8x_2IEhLDMuGZ83E0A9UubDTtAVz6Oj5xEbT2Qk_0CCX2NDgFHGG4E_fcfzADrNBqw/exec";
    let rawData = null;
    let currentBusId = null;
    let expandedFamilies = new Set();

    window.onload = () => {
        const cached = localStorage.getItem('sehc_cache_2026');
        if (cached) {
            try {
                rawData = JSON.parse(cached);
                initApp();
                showView('view-login');
                document.getElementById('loader').classList.add('hidden');
            } catch(e) { localStorage.removeItem('sehc_cache_2026'); }
        }
        fetchData(true);
        setInterval(() => fetchData(false), 30000); // 30s auto-sync
    };

    async function fetchData(isInitial) {
        if (!isInitial) document.getElementById('sync-label').innerHTML = '<i class="fa fa-sync fa-spin"></i> Syncing';
        try {
            const resp = await fetch(API_URL);
            const data = await resp.json();
            rawData = data;
            localStorage.setItem('sehc_cache_2026', JSON.stringify(data));
            initApp();
            if (currentBusId) renderList();
            if (!document.getElementById('view-admin').classList.contains('hidden')) renderAdmin();
            if (isInitial) { showView('view-login'); document.getElementById('loader').classList.add('hidden'); }
            document.getElementById('sync-label').innerHTML = '<i class="fa fa-check-circle"></i> Live';
        } catch (e) {
            document.getElementById('sync-label').innerHTML = '<i class="fa fa-exclamation-triangle text-orange-400"></i> Offline';
        }
    }

    function initApp() {
        const select = document.getElementById('login-bus');
        if (!select || !rawData.captains) return;
        const currentVal = select.value;
        select.innerHTML = '<option value="">-- Ch·ªçn s·ªë xe --</option>';
        rawData.captains.sort((a,b) => a.BusID - b.BusID).forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.BusID;
            opt.innerText = `Xe ${c.BusID} - ${c.Province} (${c.Name})`;
            select.appendChild(opt);
        });
        if (currentVal) select.value = currentVal;
    }

    function showView(id) {
        ['view-login', 'view-attendance', 'view-admin', 'loader'].forEach(v => {
            const el = document.getElementById(v); if (el) el.classList.add('hidden');
        });
        const target = document.getElementById(id); if (target) target.classList.remove('hidden');
    }

    function goBack() { currentBusId = null; expandedFamilies.clear(); showView('view-login'); }

    function handleLogin() {
        const bid = document.getElementById('login-bus').value;
        const phone = document.getElementById('login-phone').value;
        const cap = rawData.captains.find(c => c.BusID == bid && String(c.Phone).includes(phone));
        if (cap) {
            currentBusId = bid;
            document.getElementById('display-bus-id').innerText = `Xe ${bid}`;
            showView('view-attendance');
            renderList();
        } else {
            Swal.fire("L·ªói", "Th√¥ng tin Tr∆∞·ªüng xe kh√¥ng ƒë√∫ng", "error");
        }
    }

    function renderList() {
        const container = document.getElementById('passenger-list');
        const keyword = document.getElementById('search-input').value.toLowerCase();
        container.innerHTML = "";

        const busData = rawData.buses.find(b => b.BusID == currentBusId) || {};
        const passengers = rawData.passengers.filter(p => p.BusID == currentBusId);
        
        // Stats Header
        const total = passengers.length;
        const onCount = passengers.filter(p => p.StatusOn).length;
        const offCount = passengers.filter(p => p.StatusOff).length;
        document.getElementById('stat-total').innerText = `${onCount}/${total} KH√ÅCH`;
        document.getElementById('stat-on').innerText = `L√™n: ${onCount}`;
        document.getElementById('stat-off').innerText = `Xu·ªëng: ${offCount}`;
        document.getElementById('progress-fill').style.width = (total > 0 ? (onCount/total)*100 : 0) + "%";

        // Bus Status Buttons Logic
        const btnDep = document.getElementById('btn-depart');
        const btnArr = document.getElementById('btn-arrive');
        if (busData.Status === 'Departed') { btnDep.classList.add('btn-disabled'); btnDep.innerText = "ƒê√É KH·ªûI H√ÄNH"; }
        if (busData.Status === 'Arrived') { 
            btnDep.classList.add('btn-disabled'); 
            btnArr.classList.add('btn-disabled'); 
            btnArr.innerText = "ƒê√É ƒê·∫æN N∆†I"; 
        }

        const families = {};
        passengers.forEach(p => { if (!families[p.GenID]) families[p.GenID] = []; families[p.GenID].push(p); });

        Object.keys(families).sort((a,b) => {
            const aD = families[a].every(m => m.StatusOn);
            const bD = families[b].every(m => m.StatusOn);
            return aD - bD;
        }).forEach(gid => {
            const members = families[gid];
            const isAllOn = members.every(m => m.StatusOn);
            const isAllOff = members.every(m => m.StatusOff) && members.length > 0;
            if (keyword && !members.some(m => m.Name.toLowerCase().includes(keyword) || String(m.GenID).includes(keyword))) return;

            const isOpen = expandedFamilies.has(gid) || keyword !== "";
            const card = document.createElement('div');
            // Logic m√†u s·∫Øc: ∆Øu ti√™n xanh d∆∞∆°ng n·∫øu xu·ªëng h·∫øt
            card.className = `card-family shadow-sm overflow-hidden ${isAllOff ? 'family-all-off' : (isAllOn ? 'family-all-on' : '')}`;
            
            let rows = members.map(m => `
                <div class="p-4 border-t border-slate-50 ${m.StatusOn ? 'bg-green-50/40' : ''} ${m.StatusOff ? 'bg-blue-50/40' : ''}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <p class="font-bold text-sm text-slate-800">${m.Name}</p>
                            <p class="text-[9px] text-slate-400 font-bold uppercase">${m.Dept} ‚Ä¢ ${m.Note}</p>
                            <p class="text-[9px] text-blue-600 mt-1 font-bold"><i class="fa fa-route mr-1"></i>${m.Route}</p>
                        </div>
                        <a href="tel:${m.Phone}" class="btn-call shadow-sm"><i class="fa fa-phone"></i></a>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="updateAt('${gid}','${m.Name}','on')" class="flex-1 py-2.5 rounded-xl text-[10px] font-extrabold border-2 ${m.StatusOn ? 'bg-green-600 border-green-600 text-white shadow-md' : 'border-slate-200 text-slate-400'}">L√äN XE</button>
                        <button onclick="updateAt('${gid}','${m.Name}','off')" class="flex-1 py-2.5 rounded-xl text-[10px] font-extrabold border-2 ${m.StatusOff ? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'border-slate-200 text-slate-400'}">XU·ªêNG XE</button>
                        
                        <button onclick="cancelAt('${gid}','${m.Name}')" 
                                ${m.StatusOn ? 'disabled' : ''} 
                                class="px-4 rounded-xl border-2 ${m.Reason ? 'bg-red-500 border-red-500 text-white' : 'border-slate-100 text-slate-200'} ${m.StatusOn ? 'opacity-20 pointer-events-none' : ''}">
                            <i class="fa fa-user-xmark"></i>
                        </button>
                    </div>
                    ${m.Reason ? `<p class="mt-2 text-[9px] text-red-500 font-bold bg-red-50 p-1 px-2 rounded italic">L√Ω do v·∫Øng: ${m.Reason}</p>` : ''}
                </div>
            `).join('');

            card.innerHTML = `
                <div class="p-4 flex justify-between items-center" onclick="toggleF('${gid}')">
                    <div><p class="font-bold text-blue-900">${members[0].Name}</p><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Gen: ${gid}</p></div>
                    <div class="flex items-center gap-2"><span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full font-bold">${members.length} ng∆∞·ªùi</span><i class="fa ${isOpen ? 'fa-chevron-up' : 'fa-chevron-down'} text-slate-300"></i></div>
                </div>
                <div class="${isOpen ? '' : 'hidden'}">${rows}</div>
            `;
            container.appendChild(card);
        });
    }

    function updateAt(gid, name, type) {
        const p = rawData.passengers.find(x => x.GenID == gid && x.Name == name);
        const key = type === 'on' ? 'StatusOn' : 'StatusOff';
        p[key] = !p[key];
        renderList();
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "updateAttendance", genId: gid, name, type, value: p[key] }) });
    }

    async function cancelAt(gid, name) {
        const { value: reason } = await Swal.fire({
            title: 'H·ªßy tham gia?',
            text: `Nh·∫≠p l√Ω do v·∫Øng m·∫∑t cho nh√¢n vi√™n: ${name}`,
            input: 'text',
            inputPlaceholder: 'V√≠ d·ª•: B·∫≠n vi·ªác gia ƒë√¨nh, v·ªÅ xe ri√™ng...',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonText: 'ƒê√≥ng',
            confirmButtonText: 'X√°c nh·∫≠n h·ªßy',
            inputValidator: (value) => { if (!value) return 'B·∫°n ph·∫£i nh·∫≠p l√Ω do!' }
        });
    
        if (reason) {
            const p = rawData.passengers.find(x => x.GenID == gid && x.Name == name);
            if (p) {
                p.Reason = reason;
                p.StatusOn = false;
                p.StatusOff = false;
                renderList();
                fetch(API_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: "updateAttendance", genId: gid, name, type: "cancel", reason: reason }) 
                }).then(() => {
                    Swal.fire({ toast: true, position: 'top', icon: 'success', title: 'ƒê√£ c·∫≠p nh·∫≠t l√Ω do v·∫Øng', showConfirmButton: false, timer: 1500 });
                });
            }
        }
    }
    function updateBus(status) {
        Swal.fire({ title: 'X√°c nh·∫≠n?', text: `Xe ${currentBusId}: ${status}`, icon: 'warning', showCancelButton: true })
        .then(r => { if(r.isConfirmed) {
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "updateBusStatus", busId: currentBusId, status }) });
            // T·∫°m th·ªùi disable ngay l·∫≠p t·ª©c
            const bus = rawData.buses.find(b => b.BusID == currentBusId);
            if (bus) bus.Status = status;
            renderList();
        }});
    }

    async function checkAdmin() {
        const { value: pin } = await Swal.fire({ title: 'BTC PIN', input: 'password' });
        if (pin === "2026") { showView('view-admin'); renderAdmin(); }
    }

    function renderAdmin() {
        const b = rawData.buses, p = rawData.passengers, c = rawData.captains;
        const list = document.getElementById('admin-bus-list');
        list.innerHTML = "";
        let full = 0, part = 0, dep = 0, arr = 0;
        b.sort((x,y) => x.BusID - y.BusID).forEach(bus => {
            const cp = c.find(x => x.BusID == bus.BusID) || {};
            const onB = p.filter(x => x.BusID == bus.BusID);
            const onC = onB.filter(x => x.StatusOn).length;
            const isF = onC === onB.length && onB.length > 0;
            if (isF) full++; else part++;
            if (bus.Status === 'Departed') dep++; if (bus.Status === 'Arrived') arr++;
            const d = document.createElement('div');
            d.className = "bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-100";
            d.innerHTML = `<div><p class="font-bold text-blue-900">Xe ${bus.BusID} - ${cp.Province}</p><p class="text-[10px] text-slate-400 font-bold uppercase">TX: ${cp.Name} | <span class="${isF?'text-green-600 font-bold':'text-orange-500'}">${onC}/${onB.length} kh√°ch</span></p></div><a href="tel:${cp.Phone}" class="btn-call shadow-md"><i class="fa fa-phone"></i></a>`;
            list.appendChild(d);
        });
        document.getElementById('admin-stats-grid').innerHTML = `<div class="bg-white p-3 rounded-2xl border-b-4 border-green-500 shadow-sm"><p class="text-[9px] text-slate-400 font-bold uppercase">Xe ƒê·ªß</p><p class="text-xl font-black text-green-600">${full}</p></div><div class="bg-white p-3 rounded-2xl border-b-4 border-orange-500 shadow-sm"><p class="text-[9px] text-slate-400 font-bold uppercase">Xe Thi·∫øu</p><p class="text-xl font-black text-orange-600">${part}</p></div><div class="bg-blue-600 p-3 rounded-2xl shadow-sm text-white"><p class="text-[9px] opacity-70 font-bold uppercase">Kh·ªüi H√†nh</p><p class="text-xl font-black">${dep}</p></div><div class="bg-slate-900 p-3 rounded-2xl shadow-sm text-white"><p class="text-[9px] opacity-70 font-bold uppercase">ƒê·∫øn N∆°i</p><p class="text-xl font-black text-blue-400">${arr}</p></div>`;
    }

    function toggleF(id) { if (expandedFamilies.has(id)) expandedFamilies.delete(id); else expandedFamilies.add(id); renderList(); }
</script>
</body>
</html>
