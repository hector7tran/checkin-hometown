<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hometown 2026 - SEHC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; overflow-x: hidden; }
        .sticky-header { position: sticky; top: 0; z-index: 50; background: #2563eb; color: white; padding: 1rem; }
        .card-family { background: white; border-radius: 1rem; border: 1px solid #e2e8f0; transition: all 0.2s ease; }
        .family-all-on { border-left: 6px solid #22c55e !important; background-color: #f0fdf4 !important; }
        .hidden { display: none !important; }
        .btn-call { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #dcfce7; color: #166534; }
        /* Hi·ªáu ·ª©ng loading nh·∫π */
        .sync-indicator { font-size: 10px; color: rgba(255,255,255,0.7); display: flex; align-items: center; gap: 4px; }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen flex flex-col relative">

    <div id="loader" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-slate-500 font-medium">ƒêang kh·ªüi t·∫°o h·ªá th·ªëng...</p>
    </div>

    <div id="view-login" class="hidden p-6 animate__animated animate__fadeIn">
        <div class="text-center my-10">
            <div class="text-6xl mb-4">üöå</div>
            <h1 class="text-3xl font-extrabold text-blue-900 tracking-tight">Hometown 2026</h1>
            <p class="text-slate-500 font-medium">Trang ƒëi·ªÉm danh Tr∆∞·ªüng xe</p>
        </div>
        <div class="bg-white rounded-3xl p-6 shadow-xl space-y-4 border border-slate-100">
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">S·ªë xe v·∫≠n h√†nh</label>
                <select id="login-bus" class="w-full mt-1 p-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 ring-blue-500 text-sm font-semibold"></select>
            </div>
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">X√°c th·ª±c Tr∆∞·ªüng xe</label>
                <input id="login-phone" type="password" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" class="w-full mt-1 p-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 ring-blue-500 text-sm">
            </div>
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform">V√ÄO ƒêI·ªÇM DANH</button>
            <button onclick="checkAdmin()" class="w-full text-slate-400 text-xs py-2">Qu·∫£n tr·ªã Ban T·ªï Ch·ª©c</button>
        </div>
    </div>

    <div id="view-attendance" class="hidden flex-1 flex flex-col">
        <div class="sticky-header shadow-lg">
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h2 id="display-bus-id" class="text-xl font-bold">Xe 01</h2>
                    <div class="flex items-center gap-2 mt-1">
                        <div class="w-24 bg-blue-900/30 h-1.5 rounded-full overflow-hidden">
                            <div id="progress-fill" class="bg-green-400 h-full" style="width: 0%"></div>
                        </div>
                        <span id="progress-text" class="text-[10px] font-bold">0/0 kh√°ch</span>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <button onclick="goBack()" class="p-2 bg-white/20 rounded-xl active:bg-white/40"><i class="fa fa-arrow-left"></i></button>
                    <div class="sync-indicator" id="sync-label"><i class="fa fa-sync fa-spin"></i> Live</div>
                </div>
            </div>
            <div class="relative mt-2">
                <input type="text" id="search-input" onkeyup="renderList()" placeholder="T√¨m t√™n, GenID..." class="w-full p-3 pl-10 rounded-xl text-slate-900 text-sm outline-none border-none shadow-inner">
                <i class="fa fa-search absolute left-3 top-3.5 text-slate-400 text-sm"></i>
            </div>
        </div>

        <div id="passenger-list" class="p-3 space-y-3 pb-32"></div>

        <div class="fixed bottom-0 left-0 right-0 p-4 max-w-md mx-auto bg-white/80 backdrop-blur-md border-t border-slate-100 flex gap-2">
            <button onclick="updateBus('Departed')" class="flex-1 bg-green-600 text-white py-4 rounded-2xl font-bold text-sm shadow-md">XE KH·ªûI H√ÄNH</button>
            <button onclick="updateBus('Arrived')" class="flex-1 bg-blue-900 text-white py-4 rounded-2xl font-bold text-sm shadow-md">XE ƒê·∫æN N∆†I</button>
        </div>
    </div>

    <div id="view-admin" class="hidden p-4">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-extrabold text-blue-900">Ban T·ªï Ch·ª©c</h2>
            <button onclick="goBack()" class="text-slate-400 text-xl"><i class="fa fa-times"></i></button>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-6" id="admin-stats-grid"></div>
        <div id="admin-bus-list" class="space-y-3 pb-10"></div>
    </div>

</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzk8x_2IEhLDMuGZ83E0A9UubDTtAVz6Oj5xEbT2Qk_0CCX2NDgFHGG4E_fcfzADrNBqw/exec";
    let rawData = null;
    let currentBusId = null;
    let expandedFamilies = new Set();
    let syncTimer = null;

    // 1. KH·ªûI CH·∫†Y ·ª®NG D·ª§NG
    window.onload = () => {
        // ∆Øu ti√™n hi·ªÉn th·ªã d·ªØ li·ªáu t·ª´ Cache tr∆∞·ªõc
        const cached = localStorage.getItem('sehc_cache_2026');
        if (cached) {
            try {
                rawData = JSON.parse(cached);
                initApp();
                showView('view-login');
                document.getElementById('loader').classList.add('hidden');
            } catch(e) { localStorage.removeItem('sehc_cache_2026'); }
        }
        
        // T·∫£i d·ªØ li·ªáu t·ª´ server
        fetchData(true);

        // Thi·∫øt l·∫≠p t·ª± ƒë·ªông l√†m m·ªõi m·ªói 30 gi√¢y
        setInterval(() => fetchData(false), 30000);
    };

    async function fetchData(isInitial = false) {
        if (!isInitial) document.getElementById('sync-label').innerHTML = '<i class="fa fa-sync fa-spin"></i> Updating...';
        
        try {
            const resp = await fetch(API_URL);
            const data = await resp.json();
            if (data.error) throw new Error(data.error);
            
            rawData = data;
            localStorage.setItem('sehc_cache_2026', JSON.stringify(data));
            
            initApp();
            
            // C·∫≠p nh·∫≠t giao di·ªán n·∫øu ƒëang ·ªü m√†n h√¨nh danh s√°ch ho·∫∑c admin
            if (currentBusId) renderList();
            if (!document.getElementById('view-admin').classList.contains('hidden')) renderAdmin();
            
            if (isInitial) {
                showView('view-login');
                document.getElementById('loader').classList.add('hidden');
            }
            document.getElementById('sync-label').innerHTML = '<i class="fa fa-check-circle"></i> Live';
        } catch (e) {
            console.error("Fetch Error:", e);
            document.getElementById('sync-label').innerHTML = '<i class="fa fa-exclamation-triangle"></i> Offline';
            if (isInitial && !rawData) {
                Swal.fire("L·ªói k·∫øt n·ªëi", "Vui l√≤ng ki·ªÉm tra internet v√† th·ª≠ l·∫°i.", "error");
                document.getElementById('loader').classList.add('hidden');
            }
        }
    }

    function initApp() {
        const select = document.getElementById('login-bus');
        if (!select || !rawData.captains) return;
        const currentVal = select.value;
        select.innerHTML = '<option value="">-- Ch·ªçn s·ªë xe --</option>';
        rawData.captains.sort((a,b) => a.BusID - b.BusID).forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.BusID;
            opt.innerText = `Xe ${c.BusID} - ${c.Province} (${c.Name})`;
            select.appendChild(opt);
        });
        if (currentVal) select.value = currentVal;
    }

    // 2. LOGIC ƒêI·ªÄU H∆Ø·ªöNG & ƒêƒÇNG NH·∫¨P
    function showView(id) {
        ['view-login', 'view-attendance', 'view-admin', 'loader'].forEach(v => {
            const el = document.getElementById(v);
            if (el) el.classList.add('hidden');
        });
        const target = document.getElementById(id);
        if (target) target.classList.remove('hidden');
    }

    function goBack() {
        currentBusId = null;
        expandedFamilies.clear();
        document.getElementById('search-input').value = "";
        showView('view-login');
    }

    function handleLogin() {
        const bid = document.getElementById('login-bus').value;
        const phone = document.getElementById('login-phone').value;
        if (!bid || !phone) return Swal.fire("Thi·∫øu th√¥ng tin", "Vui l√≤ng ch·ªçn xe v√† nh·∫≠p s·ªë ƒëi·ªán tho·∫°i", "warning");

        const cap = rawData.captains.find(c => c.BusID == bid && String(c.Phone).includes(phone));
        if (cap) {
            currentBusId = bid;
            document.getElementById('display-bus-id').innerText = `Xe ${bid}`;
            showView('view-attendance');
            renderList();
        } else {
            Swal.fire("L·ªói x√°c th·ª±c", "S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë√∫ng v·ªõi Tr∆∞·ªüng xe n√†y", "error");
        }
    }

    // 3. LOGIC ƒêI·ªÇM DANH
    function renderList() {
        const container = document.getElementById('passenger-list');
        const keyword = document.getElementById('search-input').value.toLowerCase();
        if (!container) return;
        container.innerHTML = "";

        const passengers = rawData.passengers.filter(p => p.BusID == currentBusId);
        
        const total = passengers.length;
        const onBoard = passengers.filter(p => p.StatusOn).length;
        document.getElementById('progress-fill').style.width = (total > 0 ? (onBoard/total)*100 : 0) + "%";
        document.getElementById('progress-text').innerText = `${onBoard}/${total} kh√°ch`;

        const families = {};
        passengers.forEach(p => {
            if (!families[p.GenID]) families[p.GenID] = [];
            families[p.GenID].push(p);
        });

        const sortedIds = Object.keys(families).sort((a, b) => {
            const aDone = families[a].every(m => m.StatusOn || m.Reason);
            const bDone = families[b].every(m => m.StatusOn || m.Reason);
            return aDone - bDone;
        });

        sortedIds.forEach(gid => {
            const members = families[gid];
            const main = members.find(m => m.Note === "Ng∆∞·ªùi ƒëƒÉng k√Ω") || members[0];
            const isAllOn = members.every(m => m.StatusOn || m.Reason);
            if (keyword && !members.some(m => m.Name.toLowerCase().includes(keyword) || String(m.GenID).includes(keyword))) return;

            const isOpen = expandedFamilies.has(gid) || keyword !== "";
            const card = document.createElement('div');
            card.className = `card-family shadow-sm overflow-hidden ${isAllOn ? 'family-all-on' : ''}`;
            
            let rows = members.map(m => `
                <div class="p-4 border-t border-slate-50 ${m.StatusOn ? 'bg-green-50/40' : ''}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <p class="font-bold text-sm text-slate-800">${m.Name}</p>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">${m.Dept} ‚Ä¢ ${m.Note}</p>
                            <p class="text-[10px] text-blue-600 mt-1 font-bold"><i class="fa fa-route mr-1"></i>${m.Route || '---'}</p>
                        </div>
                        <a href="tel:${m.Phone}" class="btn-call shadow-sm"><i class="fa fa-phone"></i></a>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="updateAt('${gid}','${m.Name}','on')" class="flex-1 py-2.5 rounded-xl text-[10px] font-extrabold border-2 ${m.StatusOn ? 'bg-green-600 border-green-600 text-white shadow-md' : 'border-slate-200 text-slate-400'}">L√äN XE</button>
                        <button onclick="updateAt('${gid}','${m.Name}','off')" class="flex-1 py-2.5 rounded-xl text-[10px] font-extrabold border-2 ${m.StatusOff ? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'border-slate-200 text-slate-400'}">XU·ªêNG XE</button>
                        <button onclick="cancelAt('${gid}','${m.Name}')" ${m.StatusOn ? 'disabled' : ''} class="px-4 rounded-xl border-2 ${m.Reason ? 'bg-red-500 border-red-500 text-white' : 'border-slate-100 text-slate-200'} ${m.StatusOn ? 'opacity-20' : ''}"><i class="fa fa-user-xmark"></i></button>
                    </div>
                </div>
            `).join('');

            card.innerHTML = `
                <div class="p-4 flex justify-between items-center" onclick="toggleF('${gid}')">
                    <div><p class="font-bold text-blue-900">${main.Name}</p><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Gen: ${gid}</p></div>
                    <div class="flex items-center gap-2"><span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full font-bold">${members.length} ng∆∞·ªùi</span><i class="fa ${isOpen ? 'fa-chevron-up' : 'fa-chevron-down'} text-slate-300"></i></div>
                </div>
                <div class="${isOpen ? '' : 'hidden'}">${rows}</div>
            `;
            container.appendChild(card);
        });
    }

    function updateAt(gid, name, type) {
        const p = rawData.passengers.find(x => x.GenID == gid && x.Name == name);
        const key = type === 'on' ? 'StatusOn' : 'StatusOff';
        p[key] = !p[key];
        renderList();
        fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "updateAttendance", genId: gid, name, type, value: p[key] }) });
    }

    async function cancelAt(gid, name) {
        const { value: r } = await Swal.fire({ title: 'V·∫Øng m·∫∑t?', input: 'text', inputPlaceholder: 'L√Ω do...', showCancelButton: true });
        if (r) {
            const p = rawData.passengers.find(x => x.GenID == gid && x.Name == name);
            p.Reason = r; p.StatusOn = false; p.StatusOff = false;
            renderList();
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "updateAttendance", genId: gid, name, type: "cancel", reason: r }) });
        }
    }

    function updateBus(status) {
        Swal.fire({ title: 'X√°c nh·∫≠n?', text: `Xe ${currentBusId}: ${status}`, icon: 'question', showCancelButton: true })
        .then(r => { if(r.isConfirmed) fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "updateBusStatus", busId: currentBusId, status }) }); });
    }

    // 4. ADMIN
    async function checkAdmin() {
        const { value: pin } = await Swal.fire({ title: 'BTC PIN', input: 'password' });
        if (pin === "2026") { showView('view-admin'); renderAdmin(); }
    }

    function renderAdmin() {
        const b = rawData.buses, p = rawData.passengers, c = rawData.captains;
        let full = 0, part = 0, dep = 0, arr = 0;
        const list = document.getElementById('admin-bus-list');
        list.innerHTML = "";
        b.sort((x,y) => x.BusID - y.BusID).forEach(bus => {
            const cp = c.find(x => x.BusID == bus.BusID) || {};
            const onB = p.filter(x => x.BusID == bus.BusID);
            const onC = onB.filter(x => x.StatusOn).length;
            const isF = onC === onB.length && onB.length > 0;
            if (isF) full++; else part++;
            if (bus.Status === 'Departed') dep++;
            if (bus.Status === 'Arrived') arr++;

            const d = document.createElement('div');
            d.className = "bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-100";
            d.innerHTML = `<div><p class="font-bold text-blue-900">Xe ${bus.BusID} - ${cp.Province}</p><p class="text-[10px] text-slate-400 font-bold uppercase">TX: ${cp.Name} | <span class="${isF?'text-green-600 font-bold':'text-orange-500'}">${onC}/${onB.length} kh√°ch</span></p></div><a href="tel:${cp.Phone}" class="btn-call shadow-md"><i class="fa fa-phone"></i></a>`;
            list.appendChild(d);
        });
        document.getElementById('admin-stats-grid').innerHTML = `
            <div class="bg-white p-3 rounded-2xl border-b-4 border-green-500 shadow-sm"><p class="text-[9px] text-slate-400 font-bold uppercase">Xe ƒê·ªß</p><p class="text-xl font-black text-green-600">${full}</p></div>
            <div class="bg-white p-3 rounded-2xl border-b-4 border-orange-500 shadow-sm"><p class="text-[9px] text-slate-400 font-bold uppercase">Xe Thi·∫øu</p><p class="text-xl font-black text-orange-600">${part}</p></div>
            <div class="bg-blue-600 p-3 rounded-2xl shadow-sm text-white"><p class="text-[9px] opacity-70 font-bold uppercase">Kh·ªüi H√†nh</p><p class="text-xl font-black">${dep}</p></div>
            <div class="bg-slate-900 p-3 rounded-2xl shadow-sm text-white"><p class="text-[9px] opacity-70 font-bold uppercase">ƒê·∫øn N∆°i</p><p class="text-xl font-black text-blue-400">${arr}</p></div>`;
    }

    function toggleF(id) { if (expandedFamilies.has(id)) expandedFamilies.delete(id); else expandedFamilies.add(id); renderList(); }
</script>
</body>
</html>
