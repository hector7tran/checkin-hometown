<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒêi·ªÉm danh Hometown 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f0f4f8; color: #1e293b; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .btn-blue { background: #2563eb; color: white; transition: all 0.2s; }
        .btn-blue:active { transform: scale(0.95); opacity: 0.9; }
        .row-checked { background-color: #dcfce7 !important; border-left: 4px solid #22c55e; }
        .sticky-search { position: sticky; top: 0; z-index: 50; }
        /* T·ªëi ∆∞u cho mobile: kh√¥ng b·ªã che b·ªüi b√†n ph√≠m */
        input:focus { font-size: 16px !important; }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-md mx-auto min-h-screen relative flex flex-col">
        
        <div id="loader" class="flex-1 flex flex-col items-center justify-center p-10">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 font-medium text-blue-600">ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu...</p>
        </div>

        <div id="view-login" class="hidden animate__animated animate__fadeIn p-6">
            <div class="text-center my-10">
                <div class="text-5xl mb-4">üöå</div>
                <h1 class="text-2xl font-bold text-blue-800">Hometown 2026</h1>
                <p class="text-slate-500">H·ªá th·ªëng ƒëi·ªÉm danh Tr∆∞·ªüng xe</p>
            </div>
            <div class="glass-card rounded-2xl p-6 space-y-4">
                <select id="login-bus" class="w-full p-4 border rounded-xl bg-white shadow-sm outline-none focus:ring-2 ring-blue-500"></select>
                <input id="login-phone" type="password" placeholder="S·ªë ƒëi·ªán tho·∫°i Tr∆∞·ªüng xe" class="w-full p-4 border rounded-xl bg-white shadow-sm outline-none focus:ring-2 ring-blue-500">
                <button onclick="handleLogin()" class="w-full btn-blue font-bold py-4 rounded-xl shadow-lg">V√ÄO ƒêI·ªÇM DANH</button>
                <button onclick="showAdminLogin()" class="w-full text-slate-400 text-sm py-2">Qu·∫£n tr·ªã vi√™n BTC</button>
            </div>
        </div>

        <div id="view-attendance" class="hidden animate__animated animate__fadeIn flex-1 flex flex-col">
            <div class="bg-blue-600 p-4 text-white shadow-lg sticky top-0 z-50">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <h2 id="display-bus-id" class="text-xl font-bold">Xe 01</h2>
                        <p id="display-route" class="text-xs opacity-90"></p>
                    </div>
                    <button onclick="switchView('view-login')" class="bg-white/20 px-3 py-1 rounded-lg text-xs">Tho√°t</button>
                </div>
                <div class="relative">
                    <input type="text" id="search-input" onkeyup="filterPassengers()" placeholder="T√¨m t√™n ho·∫∑c M√£ nh√¢n vi√™n..." 
                           class="w-full p-3 pl-10 rounded-xl text-slate-800 outline-none shadow-inner">
                    <span class="absolute left-3 top-3.5 text-slate-400"><i class="fa fa-search"></i></span>
                </div>
            </div>

            <div id="passenger-list" class="p-4 space-y-4 pb-32">
                </div>

            <div class="fixed bottom-0 left-0 right-0 p-4 max-w-md mx-auto bg-white/80 backdrop-blur-md border-t flex gap-2">
                <button onclick="confirmBusStatus('Departed')" class="flex-1 bg-green-600 text-white py-3.5 rounded-xl font-bold shadow-md">XE KH·ªûI H√ÄNH</button>
                <button onclick="confirmBusStatus('Arrived')" class="flex-1 bg-blue-800 text-white py-3.5 rounded-xl font-bold shadow-md">XE ƒê·∫æN N∆†I</button>
            </div>
        </div>

        <div id="view-admin" class="hidden animate__animated animate__fadeIn p-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-800">B√°o c√°o BTC</h2>
                <button onclick="switchView('view-login')" class="text-slate-500"><i class="fa fa-times text-xl"></i></button>
            </div>
            
            <div id="admin-stats" class="grid grid-cols-2 gap-4 mb-6">
                <div class="glass-card p-4 rounded-2xl text-center border-b-4 border-green-500">
                    <p class="text-xs text-slate-500">ƒê√£ kh·ªüi h√†nh</p>
                    <p id="stat-departed" class="text-2xl font-bold">0</p>
                </div>
                <div class="glass-card p-4 rounded-2xl text-center border-b-4 border-blue-500">
                    <p class="text-xs text-slate-500">ƒê√£ ƒë·∫øn n∆°i</p>
                    <p id="stat-arrived" class="text-2xl font-bold">0</p>
                </div>
            </div>

            <div id="admin-bus-list" class="space-y-3"></div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzk8x_2IEhLDMuGZ83E0A9UubDTtAVz6Oj5xEbT2Qk_0CCX2NDgFHGG4E_fcfzADrNBqw/exec";
        let rawData = null; 
        let currentBus = null;
        let expandedFamilies = new Set(); // L∆∞u tr·∫°ng th√°i c√°c gia ƒë√¨nh ƒëang m·ªü

        window.onload = async () => {
            // T·ªëi ∆∞u: Ki·ªÉm tra cache tr∆∞·ªõc khi t·∫£i
            const cached = localStorage.getItem('hometown_data_2026');
            if (cached) {
                rawData = JSON.parse(cached);
                initApp();
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('view-login').classList.remove('hidden');
            }
            // Lu√¥n c·∫≠p nh·∫≠t ng·∫ßm d·ªØ li·ªáu m·ªõi nh·∫•t
            fetchData();
        };

        async function fetchData() {
            try {
                const resp = await fetch(API_URL);
                rawData = await resp.json();
                localStorage.setItem('hometown_data_2026', JSON.stringify(rawData));
                initApp();
                document.getElementById('loader').classList.add('hidden');
                if (!currentBus) switchView('view-login');
            } catch (e) {
                if(!rawData) Swal.fire("L·ªói", "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu", "error");
            }
        }

        function initApp() {
            const select = document.getElementById('login-bus');
            select.innerHTML = '<option value="">Ch·ªçn s·ªë xe c·ªßa b·∫°n</option>';
            rawData.captains.sort((a,b) => a.BusID - b.BusID).forEach(cap => {
                const opt = document.createElement('option');
                opt.value = cap.BusID;
                opt.innerText = `Xe ${cap.BusID} - ${cap.Name} (${cap.Province})`;
                select.appendChild(opt);
            });
        }

        function switchView(viewId) {
            ['view-login', 'view-attendance', 'view-admin'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function handleLogin() {
            const busId = document.getElementById('login-bus').value;
            const phone = document.getElementById('login-phone').value;
            const captain = rawData.captains.find(c => c.BusID == busId && c.Phone == phone);

            if (captain) {
                currentBus = busId;
                switchView('view-attendance');
                const busInfo = rawData.captains.find(c => c.BusID == currentBus);
                document.getElementById('display-bus-id').innerText = `Xe ${currentBus}`;
                document.getElementById('display-route').innerText = `Tuy·∫øn: ${busInfo.Province} - ${busInfo.District}`;
                renderPassengerList();
            } else {
                Swal.fire("L·ªói ƒëƒÉng nh·∫≠p", "S·ªë xe ho·∫∑c S·ªë ƒëi·ªán tho·∫°i kh√¥ng kh·ªõp", "error");
            }
        }

        function filterPassengers() {
            renderPassengerList();
        }

        function renderPassengerList() {
            const container = document.getElementById('passenger-list');
            const keyword = document.getElementById('search-input').value.toLowerCase();
            container.innerHTML = "";
            
            const passengers = rawData.passengers.filter(p => p.BusID == currentBus);
            const families = {};
            passengers.forEach(p => {
                if (!families[p.GenID]) families[p.GenID] = [];
                families[p.GenID].push(p);
            });

            Object.keys(families).forEach(genId => {
                const members = families[genId];
                const mainMember = members.find(m => m.Note === "Ng∆∞·ªùi ƒëƒÉng k√Ω") || members[0];
                
                // Logic l·ªçc t√¨m ki·∫øm
                const matchSearch = members.some(m => 
                    m.Name.toLowerCase().includes(keyword) || 
                    String(m.GenID).toLowerCase().includes(keyword)
                );
                if (!matchSearch && keyword !== "") return;

                const isExpanded = expandedFamilies.has(genId) || keyword !== "";
                const card = document.createElement('div');
                card.className = `glass-card rounded-2xl overflow-hidden animate__animated animate__fadeInUp`;
                
                const familyHtml = members.map(m => `
                    <div class="p-4 border-t border-slate-100 ${m.StatusOn ? 'row-checked' : ''}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <p class="font-bold text-slate-800">${m.Name} <span class="text-[10px] font-normal bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded">${m.Note}</span></p>
                                <p class="text-xs text-slate-500">${m.Dept} | Gen: ${m.GenID}</p>
                                <p class="text-[11px] text-blue-700 mt-1"><i class="fa fa-map-marker-alt"></i> ${m.Route || 'Ch∆∞a c√≥ l·ªô tr√¨nh'}</p>
                            </div>
                            <a href="tel:${m.Phone}" class="w-10 h-10 bg-green-100 text-green-600 flex items-center justify-center rounded-full ml-2">
                                <i class="fa fa-phone"></i>
                            </a>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="toggleAttend('${m.GenID}', '${m.Name}', 'on')" class="flex-1 py-2 rounded-lg text-xs font-bold border-2 ${m.StatusOn ? 'bg-green-600 border-green-600 text-white' : 'border-slate-200 text-slate-600'}">L√äN XE</button>
                            <button onclick="toggleAttend('${m.GenID}', '${m.Name}', 'off')" class="flex-1 py-2 rounded-lg text-xs font-bold border-2 ${m.StatusOff ? 'bg-blue-600 border-blue-600 text-white' : 'border-slate-200 text-slate-600'}">XU·ªêNG XE</button>
                            <button onclick="handleCancel('${m.GenID}', '${m.Name}')" ${m.StatusOn ? 'disabled' : ''} class="w-12 py-2 rounded-lg text-xs flex items-center justify-center border-2 ${m.Reason ? 'bg-red-500 border-red-500 text-white' : 'border-slate-200 text-slate-400'} ${m.StatusOn ? 'opacity-30' : ''}">
                                <i class="fa fa-user-slash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="p-4 flex justify-between items-center bg-slate-50" onclick="toggleFamily('${genId}')">
                        <span class="font-bold text-blue-800">Gƒê: ${mainMember.Name}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-xs bg-slate-200 px-2 py-0.5 rounded-full">${members.length} ng∆∞·ªùi</span>
                            <i class="fa ${isExpanded ? 'fa-chevron-up' : 'fa-chevron-down'} text-slate-400 text-xs"></i>
                        </div>
                    </div>
                    <div class="${isExpanded ? '' : 'hidden'}">
                        ${familyHtml}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function toggleFamily(genId) {
            if (expandedFamilies.has(genId)) expandedFamilies.delete(genId);
            else expandedFamilies.add(genId);
            renderPassengerList();
        }

        function toggleAttend(genId, name, type) {
            const p = rawData.passengers.find(x => x.GenID == genId && x.Name == name);
            const key = type === 'on' ? 'StatusOn' : 'StatusOff';
            p[key] = !p[key];
            
            // T·ª± ƒë·ªông g√°n l√™n xe/xu·ªëng xe cho ng∆∞·ªùi th√¢n n·∫øu mu·ªën (T√πy ch·ªçn)
            // ·ªû ƒë√¢y gi·ªØ nguy√™n y√™u c·∫ßu: nh·∫•n ai ng∆∞·ªùi ƒë√≥ ƒë·ªïi m√†u
            
            renderPassengerList();
            showToast("C·∫≠p nh·∫≠t th√†nh c√¥ng!");

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "updateAttendance", genId, name, type, value: p[key] })
            });
        }

        async function handleCancel(genId, name) {
            const { value: reason } = await Swal.fire({
                title: 'L√Ω do v·∫Øng m·∫∑t',
                input: 'text',
                inputPlaceholder: 'Nh·∫≠p l√Ω do v·∫Øng...',
                showCancelButton: true,
                confirmButtonText: 'X√°c nh·∫≠n h·ªßy',
                cancelButtonText: 'ƒê√≥ng'
            });

            if (reason) {
                const p = rawData.passengers.find(x => x.GenID == genId && x.Name == name);
                p.Reason = reason;
                p.StatusOn = false;
                p.StatusOff = false;
                renderPassengerList();
                showToast("ƒê√£ ghi nh·∫≠n v·∫Øng m·∫∑t");

                fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "updateAttendance", genId, name, type: "cancel", reason })
                });
            }
        }

        function confirmBusStatus(status) {
            Swal.fire({
                title: 'X√°c nh·∫≠n tr·∫°ng th√°i xe?',
                text: `C·∫≠p nh·∫≠t xe ${currentBus}: ${status}`,
                icon: 'question',
                showCancelButton: true
            }).then((result) => {
                if (result.isConfirmed) {
                    showToast("ƒêang ƒë·ªìng b·ªô...");
                    fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: "updateBusStatus", busId: currentBus, status: status })
                    });
                }
            });
        }

        async function showAdminLogin() {
            const { value: pin } = await Swal.fire({
                title: 'M√£ PIN Qu·∫£n tr·ªã',
                input: 'password',
                inputAttributes: { maxlength: 4, autofocus: 'true' }
            });

            if (pin === "2026") {
                switchView('view-admin');
                renderAdmin();
            } else {
                Swal.fire("Sai m√£ PIN", "", "error");
            }
        }

        function renderAdmin() {
            const departed = rawData.buses.filter(b => b.Status === 'Departed').length;
            const arrived = rawData.buses.filter(b => b.Status === 'Arrived').length;
            
            document.getElementById('stat-departed').innerText = departed;
            document.getElementById('stat-arrived').innerText = arrived;

            const container = document.getElementById('admin-bus-list');
            container.innerHTML = "";

            rawData.buses.sort((a,b) => a.BusID - b.BusID).forEach(bus => {
                const busCapt = rawData.captains.find(c => c.BusID == bus.BusID) || {};
                const busPassengers = rawData.passengers.filter(p => p.BusID == bus.BusID);
                const onBoard = busPassengers.filter(p => p.StatusOn).length;
                const isReady = onBoard === busPassengers.length && busPassengers.length > 0;

                const item = document.createElement('div');
                item.className = "glass-card p-4 rounded-xl flex justify-between items-center";
                item.innerHTML = `
                    <div>
                        <p class="font-bold text-blue-900">Xe ${bus.BusID} - ${busCapt.Province || 'N/A'}</p>
                        <p class="text-[10px] text-slate-500">Tr∆∞·ªüng xe: ${busCapt.Name || 'N/A'}</p>
                        <p class="text-[10px] text-slate-500">L·∫•p ƒë·∫ßy: ${onBoard}/${busPassengers.length}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-[9px] px-2 py-0.5 rounded-full font-bold ${isReady ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-400'}">${isReady ? 'ƒê·ª¶ KH√ÅCH' : 'CH∆ØA ƒê·ª¶'}</span>
                        <p class="text-xs font-bold mt-1 text-blue-600">${bus.Status || 'Waiting'}</p>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function showToast(msg) {
            Swal.fire({
                title: msg, toast: true, position: 'top', showConfirmButton: false, timer: 1500, background: '#2563eb', color: '#fff'
            });
        }
    </script>
</body>
</html>
