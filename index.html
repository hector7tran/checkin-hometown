<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hometown 2026 - SEHC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8fafc; color: #0f172a; font-family: 'Inter', system-ui, sans-serif; }
        .glass-card { background: white; border: 1px solid #e2e8f0; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .family-done { background-color: #dcfce7 !important; border-left: 5px solid #22c55e !important; }
        .member-done { background-color: #f0fdf4; }
        .sticky-header { position: sticky; top: 0; z-index: 100; background: #2563eb; color: white; }
        .btn-call { background: #dcfce7; color: #166534; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col">
        
        <div id="loader" class="flex-1 flex flex-col items-center justify-center p-10">
            <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-slate-500 font-medium">ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>

        <div id="view-login" class="hidden p-6 animate__animated animate__fadeIn">
            <div class="text-center my-12">
                <div class="text-6xl mb-4">üöå</div>
                <h1 class="text-2xl font-bold text-blue-900">Hometown 2026</h1>
                <p class="text-slate-500">SEHC Employee Relations</p>
            </div>
            <div class="glass-card rounded-2xl p-6 space-y-4">
                <select id="login-bus" class="w-full p-4 border rounded-xl bg-white shadow-sm outline-none focus:ring-2 ring-blue-500 text-sm"></select>
                <input id="login-phone" type="password" placeholder="M·∫≠t kh·∫©u (SƒêT Tr∆∞·ªüng xe)" class="w-full p-4 border rounded-xl outline-none focus:ring-2 ring-blue-500">
                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform">ƒêƒÇNG NH·∫¨P</button>
                <button onclick="showAdminLogin()" class="w-full text-slate-400 text-xs mt-2">Truy c·∫≠p Ban T·ªï Ch·ª©c (Admin)</button>
            </div>
        </div>

        <div id="view-attendance" class="hidden flex-1 flex flex-col">
            <div class="sticky-header p-4 shadow-xl">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h2 id="display-bus-id" class="text-xl font-bold">Xe 01</h2>
                        <div id="bus-progress-text" class="text-[11px] bg-white/20 inline-block px-2 py-0.5 rounded-full mt-1 font-semibold">ƒê√£ l√™n: 0/0</div>
                    </div>
                    <button onclick="logout()" class="text-white/80 hover:text-white"><i class="fa fa-sign-out-alt text-xl"></i></button>
                </div>
                
                <div class="relative mt-2">
                    <input type="text" id="search-input" onkeyup="renderPassengerList()" placeholder="T√¨m t√™n ho·∫∑c M√£ nh√¢n vi√™n..." 
                           class="w-full p-3 pl-10 rounded-xl text-slate-900 outline-none shadow-inner text-sm">
                    <i class="fa fa-search absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                </div>
            </div>

            <div id="passenger-list" class="p-3 space-y-3 pb-32"></div>

            <div class="fixed bottom-0 left-0 right-0 p-4 max-w-md mx-auto bg-white/90 backdrop-blur-md border-t flex gap-2">
                <button onclick="confirmBusStatus('Departed')" class="flex-1 bg-green-600 text-white py-3.5 rounded-xl font-bold text-sm shadow-md">XE KH·ªûI H√ÄNH</button>
                <button onclick="confirmBusStatus('Arrived')" class="flex-1 bg-blue-900 text-white py-3.5 rounded-xl font-bold text-sm shadow-md">XE ƒê·∫æN N∆†I</button>
            </div>
        </div>

        <div id="view-admin" class="hidden p-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-900">B√°o c√°o BTC</h2>
                <button onclick="logout()"><i class="fa fa-times text-xl text-slate-400"></i></button>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="glass-card p-4 rounded-xl text-center border-b-4 border-green-500">
                    <p class="text-[10px] uppercase text-slate-500 font-bold">Xe ƒê·ªß Kh√°ch</p>
                    <p id="stat-full-bus" class="text-2xl font-bold text-green-600">0</p>
                </div>
                <div class="glass-card p-4 rounded-xl text-center border-b-4 border-orange-500">
                    <p class="text-[10px] uppercase text-slate-500 font-bold">Xe Ch∆∞a ƒê·ªß</p>
                    <p id="stat-pending-bus" class="text-2xl font-bold text-orange-600">0</p>
                </div>
                <div class="glass-card p-3 rounded-xl text-center">
                    <p class="text-[10px] text-slate-500">Kh·ªüi h√†nh</p>
                    <p id="stat-departed" class="text-lg font-bold">0</p>
                </div>
                <div class="glass-card p-3 rounded-xl text-center">
                    <p class="text-[10px] text-slate-500">ƒê·∫øn n∆°i</p>
                    <p id="stat-arrived" class="text-lg font-bold text-blue-600">0</p>
                </div>
            </div>

            <div id="admin-bus-list" class="space-y-3"></div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzk8x_2IEhLDMuGZ83E0A9UubDTtAVz6Oj5xEbT2Qk_0CCX2NDgFHGG4E_fcfzADrNBqw/exec";
        let rawData = null;
        let currentBus = null;
        let expandedFamilies = new Set();

        window.onload = async () => {
            const cached = localStorage.getItem('hometown_cache_v3');
            if (cached) {
                rawData = JSON.parse(cached);
                initLogin();
                hideLoader();
            }
            fetchFreshData();
        };

        async function fetchFreshData() {
            try {
                const resp = await fetch(API_URL);
                rawData = await resp.json();
                localStorage.setItem('hometown_cache_v3', JSON.stringify(rawData));
                initLogin();
                hideLoader();
                if (currentBus) renderPassengerList();
            } catch (e) { console.error("Sync Error", e); }
        }

        function initLogin() {
            const select = document.getElementById('login-bus');
            select.innerHTML = '<option value="">Ch·ªçn xe c·∫ßn ƒëi·ªÉm danh</option>';
            rawData.captains.sort((a,b) => a.BusID - b.BusID).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.BusID;
                opt.innerText = `Xe ${c.BusID} - ${c.Province} (${c.Name})`;
                select.appendChild(opt);
            });
        }

        function handleLogin() {
            const bid = document.getElementById('login-bus').value;
            const phone = document.getElementById('login-phone').value;
            const cap = rawData.captains.find(c => c.BusID == bid && String(c.Phone).includes(phone));

            if (cap) {
                currentBus = bid;
                document.getElementById('display-bus-id').innerText = `Xe ${bid}`;
                showView('view-attendance');
                renderPassengerList();
            } else {
                Swal.fire("L·ªói", "Th√¥ng tin ƒëƒÉng nh·∫≠p kh√¥ng ƒë√∫ng!", "error");
            }
        }

        function renderPassengerList() {
            const container = document.getElementById('passenger-list');
            const keyword = document.getElementById('search-input').value.toLowerCase();
            container.innerHTML = "";
            
            const list = rawData.passengers.filter(p => p.BusID == currentBus);
            const totalOn = list.filter(p => p.StatusOn).length;
            document.getElementById('bus-progress-text').innerText = `ƒê√£ l√™n: ${totalOn}/${list.length}`;

            // Grouping
            const families = {};
            list.forEach(p => {
                if (!families[p.GenID]) families[p.GenID] = [];
                families[p.GenID].push(p);
            });

            // Sorting: Unfinished families go first
            const sortedGenIds = Object.keys(families).sort((a, b) => {
                const aDone = families[a].every(m => m.StatusOn);
                const bDone = families[b].every(m => m.StatusOn);
                return aDone - bDone; // false (0) comes before true (1)
            });

            sortedGenIds.forEach(genId => {
                const members = families[genId];
                const main = members.find(m => m.Note === "Ng∆∞·ªùi ƒëƒÉng k√Ω") || members[0];
                const isFamilyDone = members.every(m => m.StatusOn);

                // Search Filter
                const isMatch = members.some(m => m.Name.toLowerCase().includes(keyword) || String(m.GenID).includes(keyword));
                if (keyword && !isMatch) return;

                const isOpen = expandedFamilies.has(genId) || keyword !== "";
                const card = document.createElement('div');
                card.className = `glass-card rounded-2xl overflow-hidden transition-all ${isFamilyDone ? 'family-done' : ''}`;
                
                let memberRows = members.map(m => `
                    <div class="p-4 border-t border-slate-100 ${m.StatusOn ? 'member-done' : ''}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="font-bold text-slate-800 text-sm">${m.Name}</p>
                                <p class="text-[10px] text-slate-500">${m.Dept} | ${m.Note}</p>
                                <p class="text-[10px] text-blue-600 mt-1 font-medium"><i class="fa fa-route mr-1"></i>${m.Route || '---'}</p>
                            </div>
                            <a href="tel:${m.Phone}" class="btn-call text-sm"><i class="fa fa-phone"></i></a>
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="updateStatus('${m.GenID}', '${m.Name}', 'on')" class="flex-1 py-2 rounded-lg text-[10px] font-bold border-2 ${m.StatusOn ? 'bg-green-600 border-green-600 text-white' : 'border-slate-200 text-slate-500'}">L√äN XE</button>
                            <button onclick="updateStatus('${m.GenID}', '${m.Name}', 'off')" class="flex-1 py-2 rounded-lg text-[10px] font-bold border-2 ${m.StatusOff ? 'bg-blue-600 border-blue-600 text-white' : 'border-slate-200 text-slate-500'}">XU·ªêNG XE</button>
                            <button onclick="handleCancel('${m.GenID}', '${m.Name}')" ${m.StatusOn ? 'disabled' : ''} class="px-3 rounded-lg border-2 ${m.Reason ? 'bg-red-500 border-red-500 text-white' : 'border-slate-100 text-slate-300'} ${m.StatusOn ? 'opacity-20' : ''}">
                                <i class="fa fa-user-xmark"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="p-4 flex justify-between items-center bg-slate-50/50" onclick="toggleExpand('${genId}')">
                        <div class="flex flex-col">
                            <span class="font-bold text-sm text-blue-900">${main.Name}</span>
                            <span class="text-[10px] text-slate-400">Gen: ${genId}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] px-2 py-0.5 rounded-full bg-white border border-slate-200 font-bold">${members.length} kh√°ch</span>
                            <i class="fa ${isOpen ? 'fa-chevron-up' : 'fa-chevron-down'} text-slate-300 text-xs"></i>
                        </div>
                    </div>
                    <div class="${isOpen ? '' : 'hidden'}">${memberRows}</div>
                `;
                container.appendChild(card);
            });
        }

        function updateStatus(genId, name, type) {
            const p = rawData.passengers.find(x => x.GenID == genId && x.Name == name);
            const key = type === 'on' ? 'StatusOn' : 'StatusOff';
            p[key] = !p[key];
            renderPassengerList();
            showToast("ƒê√£ c·∫≠p nh·∫≠t");
            syncData({ action: "updateAttendance", genId, name, type, value: p[key] });
        }

        async function handleCancel(genId, name) {
            const { value: reason } = await Swal.fire({
                title: 'L√Ω do v·∫Øng m·∫∑t',
                input: 'text',
                inputPlaceholder: 'Nh·∫≠p l√Ω do...',
                showCancelButton: true
            });
            if (reason) {
                const p = rawData.passengers.find(x => x.GenID == genId && x.Name == name);
                p.Reason = reason; p.StatusOn = false; p.StatusOff = false;
                renderPassengerList();
                syncData({ action: "updateAttendance", genId, name, type: "cancel", reason });
            }
        }

        function confirmBusStatus(status) {
            Swal.fire({ title: 'X√°c nh·∫≠n?', text: `C·∫≠p nh·∫≠t tr·∫°ng th√°i xe: ${status}`, icon: 'question', showCancelButton: true }).then(r => {
                if(r.isConfirmed) {
                    showToast("ƒêang ƒë·ªìng b·ªô...");
                    syncData({ action: "updateBusStatus", busId: currentBus, status });
                }
            });
        }

        async function showAdminLogin() {
            const { value: pin } = await Swal.fire({ title: 'M√£ PIN BTC', input: 'password' });
            if (pin === "2026") {
                showView('view-admin');
                renderAdmin();
            } else { Swal.fire("L·ªói", "M√£ PIN kh√¥ng ƒë√∫ng", "error"); }
        }

        function renderAdmin() {
            const buses = rawData.buses;
            const pList = rawData.passengers;
            
            let fullCount = 0;
            let pendingCount = 0;

            const container = document.getElementById('admin-bus-list');
            container.innerHTML = "";

            buses.sort((a,b) => a.BusID - b.BusID).forEach(bus => {
                const capt = rawData.captains.find(c => c.BusID == bus.BusID) || {};
                const passengers = pList.filter(p => p.BusID == bus.BusID);
                const onBoard = passengers.filter(p => p.StatusOn).length;
                const isFull = onBoard === passengers.length && passengers.length > 0;
                
                if (isFull) fullCount++; else pendingCount++;

                const card = document.createElement('div');
                card.className = "glass-card p-4 rounded-xl flex justify-between items-center";
                card.innerHTML = `
                    <div class="flex-1">
                        <p class="font-bold text-blue-900">Xe ${bus.BusID} - ${capt.Province || 'N/A'}</p>
                        <p class="text-[10px] text-slate-500">Tr∆∞·ªüng xe: ${capt.Name || '---'}</p>
                        <div class="flex items-center gap-2 mt-1">
                             <span class="text-[10px] font-bold ${isFull ? 'text-green-600' : 'text-orange-500'}">${onBoard}/${passengers.length} kh√°ch</span>
                             <span class="text-[9px] bg-slate-100 px-1.5 rounded">${bus.Status || 'Waiting'}</span>
                        </div>
                    </div>
                    <a href="tel:${capt.Phone}" class="btn-call ml-4"><i class="fa fa-phone"></i></a>
                `;
                container.appendChild(card);
            });

            document.getElementById('stat-full-bus').innerText = fullCount;
            document.getElementById('stat-pending-bus').innerText = pendingCount;
            document.getElementById('stat-departed').innerText = buses.filter(b => b.Status === 'Departed').length;
            document.getElementById('stat-arrived').innerText = buses.filter(b => b.Status === 'Arrived').length;
        }

        // Utils
        function syncData(payload) {
            fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        }
        function toggleExpand(id) {
            if (expandedFamilies.has(id)) expandedFamilies.delete(id); else expandedFamilies.add(id);
            renderPassengerList();
        }
        function showView(id) {
            ['view-login', 'view-attendance', 'view-admin'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function hideLoader() { document.getElementById('loader').classList.add('hidden'); }
        function logout() { location.reload(); }
        function showToast(m) { Swal.fire({ title: m, toast: true, position: 'top', showConfirmButton: false, timer: 1500, background: '#2563eb', color: '#fff' }); }
    </script>
</body>
</html>
